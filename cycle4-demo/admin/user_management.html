<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/cycle4-demo/admin/user_management.css" />
  <title>User Management | IDS Fasa 4</title>
  <link rel="icon" type="image/x-icon" href="/ids logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Basic&family=Chakra+Petch&family=Hind+Madurai&family=Poppins&family=Share+Tech&family=Source+Sans+3&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .main-content {
      transition: margin-left 0.3s ease;
      padding: 20px;
      margin-left: 0;
    }
    .main-content.shifted {
      margin-left: 250px;
    }
  </style>
</head>
<body>
  <!-- ✅ Navbar -->
  <div class="navbar">
    <span class="hamburger" id="hamburger">&#9776;</span>
    <span class="navbar-title">IDS | Permantauan Dinamika Pembangunan Kerajaan (2025)</span>
    <span id="username" class="navbar-username">
      <i class="fas fa-user" style="margin-right:10px;"></i>Memuat...
    </span>
  </div>

  <!-- ✅ Sidepanel -->
  <div id="sidePanel" class="sidepanel">
    <a href="/cycle4-demo/admin/index.html"><i class="fas fa-chart-line" style="margin-right:10px;"></i> Dashboard</a>
    <a href="/cycle4-demo/admin/responses_records.html"><i class="fas fa-clipboard-list" style="margin-right:10px;"></i> Rekod Responden</a>
    <a href="/cycle4-demo/admin/user_management_2.html"><i class="fas fa-user" style="margin-right:10px;"></i> User Management</a>
    <a href="/cycle4-demo/logout.html" id="logout-button-sidebar" style="background-color: red; margin-top: 30px;">
      <i class="fas fa-sign-out-alt" style="margin-right:10px;"></i> Log Keluar
    </a>
  </div>

  <!-- ✅ Main Content -->
  <div class="main-content" id="mainContent">
    <h2>User Management</h2>
    <button id="addUserBtn" class="add-user-button">+ Add User</button>

    <table id="userTable">
      <thead>
        <tr class="headers-table">
          <th>Name</th>
          <th>Role</th>
          <th>Enumerator Code</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- ✅ Modal -->
    <div id="userModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Add / Edit User</h3>
        <hr/>
        <form id="userForm">
          <label>Name</label>
          <input type="text" name="name" placeholder="Name" required />

          <label>Role</label>
          <select name="role" required>
            <option value="">Select Role</option>
            <option value="Admin">Admin</option>
            <option value="Enumerator">Enumerator</option>
          </select>

          <label>Enumerator Code</label>
          <input type="text" name="enumerator_code" placeholder="Enumerator Code" required />

          <label>Password</label>
          <input type="password" name="password" placeholder="Password" />

          <label>Confirmed Password</label>
          <input type="password" name="confirmPassword" placeholder="Confirm Password" />

          <div class="button-container">
            <button class="submit-button" type="submit"><i class="fas fa-save" style="margin-right:10px;"></i>Save User</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ✅ Your Existing JavaScript (unchanged) -->
  <script>
    const modal = document.getElementById('userModal');
    const form = document.getElementById('userForm');
    const tableBody = document.querySelector('#userTable tbody');
    const openBtn = document.getElementById('addUserBtn');
    const closeBtn = document.querySelector('.close');
    let editUserId = null;

    openBtn.onclick = () => {
      editUserId = null;
      form.reset();
      modal.style.display = 'block';
    };

    closeBtn.onclick = () => modal.style.display = 'none';

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        name: form.name.value.trim(),
        role: form.role.value,
        enumerator_code: form.enumerator_code.value.trim(),
        password: form.password.value,
        confirmPassword: form.confirmPassword.value
      };
      if (formData.password && formData.password !== formData.confirmPassword) {
        alert("Passwords do not match");
        return;
      }
      const url = editUserId
        ? `https://atiqahst-github-io.onrender.com/users/${editUserId}`
        : `https://atiqahst-github-io.onrender.com/users`;
      const method = editUserId ? 'PUT' : 'POST';

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || "Operation failed");
        }
        alert(editUserId ? "User updated!" : "User created!");
        modal.style.display = 'none';
        form.reset();
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    });

    async function loadUsers() {
      try {
        const res = await fetch('https://atiqahst-github-io.onrender.com/users');
        const users = await res.json();

        tableBody.innerHTML = '';
        users.forEach(user => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-id', user.id);
          tr.innerHTML = `
            <td>${user.name}</td>
            <td>${user.role}</td>
            <td>${user.enumerator_code}</td>
            <td>${new Date(user.created_at).toLocaleString()}</td>
            <td>
              <button class="edit-btn"><i class="fas fa-edit"></i></button>
              <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
            </td>
          `;
          tableBody.appendChild(tr);
        });

        attachActionListeners();
      } catch (err) {
        alert('Failed to load users');
      }
    }

    function attachActionListeners() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', handleEdit);
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDelete);
      });
    }

    function handleEdit(e) {
      const row = e.target.closest('tr');
      editUserId = row.getAttribute('data-id');
      form.name.value = row.children[0].textContent;
      form.role.value = row.children[1].textContent;
      form.enumerator_code.value = row.children[2].textContent;
      form.password.value = '';
      form.confirmPassword.value = '';
      modal.style.display = 'block';
    }

    async function handleDelete(e) {
      const row = e.target.closest('tr');
      const userId = row.getAttribute('data-id');
      const confirmDelete = confirm("Are you sure you want to delete this user?");
      if (!confirmDelete) return;

      try {
        const res = await fetch(`https://atiqahst-github-io.onrender.com/users/${userId}`, {
          method: "DELETE"
        });
        if (!res.ok) throw new Error("Delete failed");
        alert("User deleted successfully");
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    }

    loadUsers();
  </script>

  <!-- ✅ Hamburger & User Session Script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ✅ User session
      const userData = JSON.parse(sessionStorage.getItem("userData") || "{}");
      const displayName = userData.enumerator_code || userData.name || "Pengguna";
      const usernameEl = document.getElementById("username");
      if (usernameEl) {
        usernameEl.innerHTML = `<i class="fas fa-user" style="margin-right:10px;"></i>${displayName}`;
        usernameEl.title = userData.role || "";
      }

      // ✅ Logout
      document.getElementById("logout-button-sidebar").addEventListener("click", () => {
        sessionStorage.clear();
        const totalRespondents = localStorage.getItem("totalRespondents");
        localStorage.clear();
        if (totalRespondents !== null) {
          localStorage.setItem("totalRespondents", totalRespondents);
        }
        sessionStorage.setItem("justLoggedOut", "true");
        window.location.href = "logout.html";
      });

      // ✅ Redirect if not logged in
      if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'index.html';
      }

      // ✅ Hamburger toggle logic (✨ ADDED THIS ✨)
      const hamburger = document.getElementById("hamburger");
      const sidePanel = document.getElementById("sidePanel");

      hamburger.addEventListener("click", () => {
        sidePanel.classList.toggle("open");
      });
    });
  </script>
</body>
</html>
