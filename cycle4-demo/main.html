<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>IDS|Fasa 4 (2025)</title>
    <link rel="icon" type="image/x-icon" href="ids_logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Basic&family=Chakra+Petch:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Hind+Madurai:wght@300;400;500;600;700&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Share+Tech&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">


</head>
<body>

<div class="navbar">
  <span class="hamburger" id="hamburger">&#9776;</span>
  <span class="navbar-title">IDS | Permantauan Dinamika Pembangunan Kerajaan</span>
  <span id="username" class="navbar-username">
    <i class="fas fa-user" style="margin-right:10px;"></i>Memuat...
  </span>
</div>


<div id="sidePanel" class="sidepanel">
  <a href="/cycle4-demo/main.html">
    <i class="fas fa-clipboard-list" style="margin-right:10px;"></i> Kaji Selidik
  </a>
  <a href="#">
    <i class="fas fa-clock-rotate-left" style="margin-right:10px;"></i> Rekod Responden
  </a>
  <a href="#">
    <i class="fas fa-user" style="margin-right:10px;"></i> Profil
  </a>
  <a href="#" id="logout-button-sidebar" style="background-color: red; margin-top: 30px;">
    <i class="fas fa-sign-out-alt" style="margin-right:10px;"></i> Log Keluar
  </a>
</div>

  <!-- Top right corner logout
    <button id="logout-button" class="logout-button">
        <i class="fas fa-sign-out-alt" style="margin-right:5px;"></i> Log Keluar
    </button> -->

    <div class="top-header">
        <!-- Logo IDS at the top left-->
        <img class="idsLogo" src="/cycle4-demo/ids_logo.png" alt="IDS Logo">
         <!-- Powered By at the top right-->
        <div class="poweredBy">
        <p> Powered By:</p>
        <img class="dataBlu" src="/cycle4-demo/DataBlu_Logo.png" alt="DataBlu_Logo">
        </div>
    </div>
    <!-- Clock with Date based onthe device-->
       <div class="clock-wrapper">
    <!-- Show only location here (no lat/lon) -->
    <div id="location" class="location-display">Mengesan lokasi...</div>
    <br>

    <div class="clock-display">
        <div id="clock-time" class="clock-time"></div>
        <hr class="clock-divider">
        <div id="clock-date" class="clock-date"></div>
    </div>

    <div class="respondents" id="todayRespondents">
        Dikemaskini setakat () - 0 Responden
    </div>
</div>

     <!-- <div class="clock-wrapper">
            <div class="clock-display">
                <div id="clock-time" class="clock-time"></div>
                <hr class="clock-divider">
                <div id="clock-date" class="clock-date"></div>
            </div>

            <div class="respondents" id="todayRespondents"> Dikemaskini setakat () - 0 Responden</div>
    </div> -->

    <div class="container-view">
        <div id="message-view"></div>
        <div id="survey-container" class= "surveyQuestions"> </div>
    </div>

    <!--Sound Effect everytime when a user selects an answer-->
    <audio id="clickSound" src="clickSoundEffect.mp3"></audio> <!-- Sound file -->

    <script type="module" src="survey.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>

  const hamburger = document.getElementById("hamburger");
  const sidePanel = document.getElementById("sidePanel");

  hamburger.addEventListener("click", () => {
    sidePanel.style.width = sidePanel.style.width === "250px" ? "0" : "250px";
  });

  document.getElementById("logout-button-sidebar").addEventListener("click", () => {
    sessionStorage.clear();
    const totalRespondents = localStorage.getItem("totalRespondents");

    localStorage.removeItem("currentUserId");
    localStorage.removeItem("showIdInput");
    localStorage.removeItem("surveyCompleted");
    localStorage.removeItem("currentSurvey");
    localStorage.removeItem("pushedRespondentIds");

    if (totalRespondents !== null) {
      localStorage.setItem("totalRespondents", totalRespondents);
    }

    sessionStorage.setItem("justLoggedOut", "true");
    window.location.href = "logout.html";
  });


    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
    window.location.href = 'index.html'; // Redirect to login if not authenticated
    }

    function closeModal() {
        document.getElementById("customModal").style.display = "none";
        document.getElementById("saveDatabaseModal").style.display = "none";
        document.getElementById("errorDatabaseModal").style.display = "none";
    }

    function showToast(message, type = "error", duration = 4000) {
        const container = document.getElementById("toast-container");

        const toast = document.createElement("div");
        toast.classList.add("toast", `toast-${type}`); // Add the dynamic class based on type

        toast.innerHTML = `
            <span>${message}</span>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, duration);
    }


async function fetchLocationName(lat, lon) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'LiveLocationApp/1.0 (your-email@example.com)' // Replace with your contact info
      }
    });
    if (!response.ok) throw new Error('Reverse geocoding failed');

    const data = await response.json();
    const location = data.display_name || 'Lokasi tidak dapat dikenalpasti';

    document.querySelectorAll('.location-display').forEach(el => {
      el.textContent = location;
    });

    // Save to localStorage (currentSurvey)
    let survey = JSON.parse(localStorage.getItem("currentSurvey") || '{"answers":{}}');
    survey.answers = survey.answers || {};
    survey.answers.location = location;
    localStorage.setItem("currentSurvey", JSON.stringify(survey));

  } catch (error) {
    console.error('Error fetching location:', error);
    document.querySelectorAll('.location-display').forEach(el => {
      el.textContent = 'Error retrieving location';
    });
  }
}



  //     async function fetchLocationName(lat, lon) {
  //   try {
  //     const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14&addressdetails=1`;
  //     const response = await fetch(url, {
  //       headers: {
  //         'User-Agent': 'LiveLocationApp/1.0 (your-email@example.com)' // Replace with your contact info
  //       }
  //     });
  //     if (!response.ok) throw new Error('Reverse geocoding failed');

  //     const data = await response.json();
  //     const address = data.address || {};

  //     // Collect relevant location parts
  //     const locationParts = [];
  //     if (address.city) locationParts.push(address.city);
  //     else if (address.town) locationParts.push(address.town);
  //     else if (address.village) locationParts.push(address.village);
  //     else if (address.hamlet) locationParts.push(address.hamlet);
  //     else if (address.suburb) locationParts.push(address.suburb);

  //     if (address.state) locationParts.push(address.state);
  //     if (address.country) locationParts.push(address.country);

  //     const location = locationParts.join(', ') || 'Unknown location';

  //     // document.getElementById('location').textContent = location;
  //         // ✅ Update ALL elements with location display
  //   document.querySelectorAll('.location-display').forEach(el => {
  //     el.textContent = location;
  //   });

  //   // ✅ Save to localStorage (currentSurvey)
  //   let survey = JSON.parse(localStorage.getItem("currentSurvey") || '{"answers":{}}');
  //   survey.answers = survey.answers || {};
  //   survey.answers.location = location;
  //   localStorage.setItem("currentSurvey", JSON.stringify(survey));

  //   } catch (error) {
  //     console.error('Error fetching location:', error);
  //     document.getElementById('location').textContent = 'Error retrieving location';
  //   }

  // }


// function updateLocation(position) {
//   const lat = position.coords.latitude;
//   const lon = position.coords.longitude;

//   if (navigator.onLine) {
//     // ONLINE: Try reverse geocoding to get location name
//     document.querySelectorAll('.location-display').forEach(el => {
//       el.textContent = 'Menentukan lokasi anda (atas talian)...';
//     });
//     fetchLocationName(lat, lon);
//   } else {
//     // OFFLINE: Fallback to raw GPS coordinates
//     const rawLocation = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
//     document.querySelectorAll('.location-display').forEach(el => {
//       el.textContent = rawLocation;
//     });

//     // Store in localStorage
//     let survey = JSON.parse(localStorage.getItem("currentSurvey") || '{"answers":{}}');
//     survey.answers.location = rawLocation;
//     localStorage.setItem("currentSurvey", JSON.stringify(survey));
//   }
// }


function updateLocation(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  if (navigator.onLine) {
    document.querySelectorAll('.location-display').forEach(el => {
      el.textContent = 'Menentukan lokasi anda (atas talian)...';
    });
    fetchLocationName(lat, lon);
  } else {
    // OFFLINE: fallback to raw GPS coordinates
    const rawLocation = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
    document.querySelectorAll('.location-display').forEach(el => {
      el.textContent = rawLocation;
    });

    let survey = JSON.parse(localStorage.getItem("currentSurvey") || '{"answers":{}}');
    survey.answers = survey.answers || {};
    survey.answers.latitude = lat;
    survey.answers.longitude = lon;
    survey.answers.locationName = rawLocation;
    localStorage.setItem("currentSurvey", JSON.stringify(survey));

    // Store last known location for fallback
  localStorage.setItem("lastKnownLocation", JSON.stringify({
  latitude: lat,
  longitude: lon,
  locationName: locationName  // or rawLocation in offline case
}));

  }
}

function fetchLocationName(lat, lon) {
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;

  fetch(url, {
    headers: {
      'User-Agent': 'SurveyApp/1.0 (youremail@example.com)'  // Replace with your email
    }
  })
    .then(response => response.json())
    .then(data => {
      const address = data.address || {};
      // Construct full address string (you can customize which parts to include)
      const parts = [
        address.road,
        address.neighbourhood,
        address.suburb,
        address.city || address.town || address.village || address.hamlet,
        address.state,
        address.postcode,
        address.country
      ];
      const locationName = parts.filter(Boolean).join(', ') || 'Lokasi tidak dapat dikenalpasti';

      document.querySelectorAll('.location-display').forEach(el => {
        el.textContent = locationName;
      });

      // Save lat, lon, and location name
      let survey = JSON.parse(localStorage.getItem("currentSurvey") || '{"answers":{}}');
      survey.answers = survey.answers || {};
      survey.answers.latitude = lat;
      survey.answers.longitude = lon;
      survey.answers.locationName = locationName;
      localStorage.setItem("currentSurvey", JSON.stringify(survey));

      // Store last known location for fallback
      localStorage.setItem("lastKnownLocation", JSON.stringify({
        latitude: lat,
        longitude: lon,
        locationName: locationName  // or rawLocation in offline case
      }));

    })
    .catch(error => {
      console.error('Reverse geocoding failed:', error);
      document.querySelectorAll('.location-display').forEach(el => {
        el.textContent = 'Tidak dapat menentuk lokasi (tiada internet)';
      });
    });
}



function handleError(error) {
  console.error('Error getting location:', error);
  document.querySelectorAll('.location-display').forEach(el => {
    el.textContent = 'Akses lokasi ditolak atau tidak tersedia';
  });
}

function requestLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(updateLocation, handleError, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    });
  } else {
    alert('Geolocation tidak disokong oleh pelayar anda.');
  }
}

// Call this once on page load
requestLocation();

// Listen for connection changes
window.addEventListener("online", requestLocation);
window.addEventListener("offline", requestLocation);


// function updateLocation(position) {
//   const lat = position.coords.latitude;
//   const lon = position.coords.longitude;

//   if (navigator.onLine) {
//     document.querySelectorAll('.location-display').forEach(el => {
//       el.textContent = 'Menentukan lokasi anda (atas talian)...';
//     });
//     fetchLocationName(lat, lon);
//   } else {
//     const rawLocation = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;

//     document.querySelectorAll('.location-display').forEach(el => {
//       el.textContent = rawLocation;
//     });

//     // Save raw coordinates to localStorage
//     let survey = JSON.parse(localStorage.getItem("currentSurvey") || '{"answers":{}}');
//     survey.answers = survey.answers || {};
//     survey.answers.location = rawLocation;
//     localStorage.setItem("currentSurvey", JSON.stringify(survey));
//   }
// }



//   // function updateLocation(position) {
//   //   const lat = position.coords.latitude;
//   //   const lon = position.coords.longitude;
//   //   document.getElementById('location').textContent = 'Menentukan lokasi anda...';
//   //   fetchLocationName(lat, lon);
//   // }

//   function handleError(error) {
//     console.error('Error getting location:', error);
//     document.getElementById('location').textContent = 'Akses lokasi ditolak atau tidak tersedia';
//   }

//   if (navigator.geolocation) {
//       navigator.geolocation.watchPosition(updateLocation, handleError, {
//         enableHighAccuracy: true,
//         maximumAge: 0,
//         timeout: 10000
//       });
//   } else {
//     alert('Geolocation tidak disokong oleh pelayar anda.');
//   }

  const INACTIVITY_LIMIT = 15 * 60 * 1000; // 5 minutes in milliseconds
  let inactivityTimer;
  let remainingTime = INACTIVITY_LIMIT;
  let countdownInterval;

  function updateCountdownDisplay() {
    const minutes = Math.floor(remainingTime / 60000);
    const seconds = Math.floor((remainingTime % 60000) / 1000);
    const countdownEl = document.getElementById("countdown");
    if (countdownEl) {
      countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
  }

  function startCountdown() {
    clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
      remainingTime -= 1000;
      if (remainingTime <= 0) {
        clearInterval(countdownInterval);
      }
      updateCountdownDisplay();
    }, 1000);
  }

  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    clearInterval(countdownInterval);

    remainingTime = INACTIVITY_LIMIT;
    updateCountdownDisplay();
    startCountdown();

    inactivityTimer = setTimeout(() => {
      autoLogout();
    }, INACTIVITY_LIMIT);
  }

  function autoLogout() {
    sessionStorage.clear();
    const totalRespondents = localStorage.getItem("totalRespondents");

    // Remove relevant items
    localStorage.removeItem("currentUserId");
    localStorage.removeItem("showIdInput");
    localStorage.removeItem("surveyCompleted");
    localStorage.removeItem("currentSurvey");
    localStorage.removeItem("pushedRespondentIds");

    if (totalRespondents !== null) {
      localStorage.setItem("totalRespondents", totalRespondents);
    }

    sessionStorage.setItem("justLoggedOut", "true");
    window.location.href = "logout.html";
  }

  // Attach listeners to reset timer on user activity
  ['click', 'mousemove', 'keydown', 'touchstart'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer);
  });

  // Start on page load
  resetInactivityTimer();




    //     async function fetchLocationName(lat, lon) {
    //   try {
    //     const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
    //     const response = await fetch(url, {
    //       headers: {
    //         'User-Agent': 'LiveLocationApp/1.0 (amiirul@stadvisory.com)' // Replace with your email for polite usage
    //       }
    //     });

    //     if (!response.ok) {
    //       throw new Error('Reverse geocoding failed.');
    //     }

    //     const data = await response.json();
    //     const address = data.address;
    //     const city = address.city || address.town || address.village || address.hamlet || '';
    //     const country = address.country || '';
    //     const locationText = `${city}, ${country}`;
    //     document.getElementById('location').textContent = locationText;

    //   } catch (error) {
    //     console.error("Error fetching location name:", error);
    //     document.getElementById('location').textContent = "Error retrieving location";
    //   }
    // }

    // function updateLocation(position) {
    //   const lat = position.coords.latitude;
    //   const lon = position.coords.longitude;
    //   // document.getElementById('latitude').textContent = lat.toFixed(6);
    //   // document.getElementById('longitude').textContent = lon.toFixed(6);
    //   fetchLocationName(lat, lon);
    // }

    // function handleError(error) {
    //   console.error("Error getting location: ", error);
    //   document.getElementById('location').textContent = "Permission denied or unavailable";
    // }

    // if (navigator.geolocation) {
    //   navigator.geolocation.watchPosition(updateLocation, handleError, {
    //     enableHighAccuracy: true,
    //     maximumAge: 0,
    //     timeout: 10000
    //   });
    // } else {
    //   alert("Geolocation is not supported by your browser.");

document.getElementById("logout-button").addEventListener("click", () => {
  //Clear session storage (login/session info)
  sessionStorage.clear();

  //Temporarily store totalRespondents
  const totalRespondents = localStorage.getItem("totalRespondents");

  //Remove specific survey-related data (including response ID)
  localStorage.removeItem("currentUserId");
  localStorage.removeItem("showIdInput");
  localStorage.removeItem("surveyCompleted");
  localStorage.removeItem("currentSurvey");
  localStorage.removeItem("pushedRespondentIds");

  //Restore totalRespondents value
  if (totalRespondents !== null) {
    localStorage.setItem("totalRespondents", totalRespondents);
  }

  sessionStorage.setItem("justLoggedOut", "true");

  //Redirect to login page
  window.location.href = "logout.html"; // Or your login page

    window.addEventListener('online', () => {
    console.log('User is back online');
  });

  window.addEventListener('offline', () => {
    console.log('User went offline');
  });


});

    </script>

<script>
// Wait until the DOM is ready
document.addEventListener("DOMContentLoaded", () => {
  // Retrieve user data from sessionStorage
  const userData = JSON.parse(sessionStorage.getItem("userData") || "{}");

  // Try to use enumerator_code or fallback to name
  const displayName = userData.enumerator_code || userData.name || "Pengguna";

  // Replace username in the navbar
  const usernameEl = document.getElementById("username");
  if (usernameEl) {
    usernameEl.innerHTML = `<i class="fas fa-user" style="margin-right:10px;"></i>${displayName}`;
    usernameEl.title = userData.role || ""; // Optional: show role as tooltip
  }
});
</script>


    <!-- Toast Notification Container -->
    <!--Toast Message-->
    <div id="toast-container"></div>


    <!-- Custom Modal Popup -->
    <div id="customModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <div class="modal-icon"><img src="/cycle4-demo/check-icon.png" alt="check-icon"></div>
        <h2>Sesi Ditamatkan</h2>
        <p>Respon anda telah disimpan! Terima kasih!</p>
    </div>
    </div>

   <!--Pop - Up Window for Succcessful Message of Pushing Data to the Actual Database-->
    <div id="saveDatabaseModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <div class="modal-icon"><img src="/cycle4-demo/successful_database.png" alt="save_"></div>
        <h2>Berjaya!</h2>
        <p>Semua data telah disimpan</p>
    </div>
    </div>

    <!--Pop - Up Window for Error Message of Pushing Data to the Actual Database-->
    <div id="errorDatabaseModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <div class="modal-icon"><img src="/cycle4-demo/error_database.png" alt="error-icon"></div>
        <h2>Error!</h2>
        <p>Data anda tidak dapat disimpan. Sila pastikan sambungan intenet anda stabil.</p>
    </div>
    </div>


    <!-- Minimal floating pop-up -->
    <div id="surveyCloseModal" class="clean-popup">
        <img src="/cycle4-demo/clock.png" alt="clock icon" class="popup-icon" />
        <h2>Maaf!</h2>
        <p>Kajiselidik ini hanya boleh dilakukan dari jam <strong>6 pagi sehingga 8 malam</strong></p>
    </div>

    <div id="timeout-timer">
    Sesi akan tamat secara automatik dalam: <span id="countdown">--:--</span>
    </div>

</body>



<!--Version No. if there are any updates, bug fixes or new features applied-->
<footer>
    <p>v 4.1.17</p>
</footer>
</html> 