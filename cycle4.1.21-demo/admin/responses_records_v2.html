<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/cycle4-demo/admin/index.css" />
  <title>Dashboard | IDS Fasa 4</title>
  <link rel="icon" type="image/x-icon" href="ids_logo.png" />
  <link
    href="https://fonts.googleapis.com/css2?family=Basic&family=Chakra+Petch&family=Hind+Madurai&family=Poppins&family=Share+Tech&family=Source+Sans+3&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
  <!-- Navbar -->
  <div class="navbar">
    <span class="hamburger" id="hamburger">&#9776;</span>
    <span class="navbar-title">IDS | Permantauan Dinamika Pembangunan Kerajaan</span>
    <span id="username" class="navbar-username">
      <i class="fas fa-user" style="margin-right:10px;"></i>Memuat...
    </span>
  </div>

  <!-- Sidepanel -->
  <div id="sidePanel" class="sidepanel">
    <a href="/cycle4.1.21-demo/admin/index.html"><i class="fas fa-chart-line" style="margin-right:10px;"></i> Dashboard</a>
    <a class="active" href="/cycle4.1.21-demo/admin/responses_records_v2.html"><i class="fas fa-clipboard-list" style="margin-right:10px;"></i> Rekod Responden</a>
    <a href="/cycle4.1.21-demo/admin/user_management_2.html"><i class="fas fa-user" style="margin-right:10px;"></i> User Management</a>
    <a href="/cycle4.1.21-demo/logout.html" id="logout-button-sidebar" style="background-color: red; margin-top: 30px;">
      <i class="fas fa-sign-out-alt" style="margin-right:10px;"></i> Log Keluar
    </a>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <h2>Rekod Responden</h2>
    <table id="respondent-table" style="width: 80%; margin: 20px auto; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="border: 1px solid #ccc; padding: 10px;">Tarikh</th>
          <th style="border: 1px solid #ccc; padding: 10px;">Kod Enumerator</th>
          <th style="border: 1px solid #ccc; padding: 10px;">Jumlah Responden</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="timeout-timer">
      Sesi akan tamat secara automatik dalam: <span id="countdown">--:--</span>
    </div>
  </div>

  <!-- Inactivity, Navbar, Sidebar Logic -->
  <script>
    const hamburger = document.getElementById("hamburger");
    const sidePanel = document.getElementById("sidePanel");
    const mainContent = document.getElementById("mainContent");

    hamburger.addEventListener("click", () => {
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        sidePanel.classList.toggle("open");
      } else {
        const isOpen = sidePanel.classList.contains("open");
        sidePanel.classList.toggle("open", !isOpen);
        sidePanel.style.width = isOpen ? "0" : "250px";
        mainContent.style.marginLeft = isOpen ? "0" : "250px";
        mainContent.classList.toggle("shifted", !isOpen);
      }
    });

    document.getElementById("logout-button-sidebar").addEventListener("click", () => {
      sessionStorage.clear();
      const totalRespondents = localStorage.getItem("totalRespondents");

      localStorage.removeItem("currentUserId");
      localStorage.removeItem("showIdInput");
      localStorage.removeItem("surveyCompleted");
      localStorage.removeItem("currentSurvey");
      localStorage.removeItem("pushedRespondentIds");

      if (totalRespondents !== null) {
        localStorage.setItem("totalRespondents", totalRespondents);
      }

      sessionStorage.setItem("justLoggedOut", "true");
      window.location.href = "logout.html";
    });

    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'index.html';
    }

    const INACTIVITY_LIMIT = 15 * 60 * 1000;
    let inactivityTimer;
    let remainingTime = INACTIVITY_LIMIT;
    let countdownInterval;

    function updateCountdownDisplay() {
      const minutes = Math.floor(remainingTime / 60000);
      const seconds = Math.floor((remainingTime % 60000) / 1000);
      const countdownEl = document.getElementById("countdown");
      if (countdownEl) {
        countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }

    function startCountdown() {
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        remainingTime -= 1000;
        if (remainingTime <= 0) {
          clearInterval(countdownInterval);
        }
        updateCountdownDisplay();
      }, 1000);
    }

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      clearInterval(countdownInterval);
      remainingTime = INACTIVITY_LIMIT;
      updateCountdownDisplay();
      startCountdown();

      inactivityTimer = setTimeout(autoLogout, INACTIVITY_LIMIT);
    }

    function autoLogout() {
      sessionStorage.clear();
      const totalRespondents = localStorage.getItem("totalRespondents");

      localStorage.removeItem("currentUserId");
      localStorage.removeItem("showIdInput");
      localStorage.removeItem("surveyCompleted");
      localStorage.removeItem("currentSurvey");
      localStorage.removeItem("pushedRespondentIds");

      if (totalRespondents !== null) {
        localStorage.setItem("totalRespondents", totalRespondents);
      }

      sessionStorage.setItem("justLoggedOut", "true");
      window.location.href = "logout.html";
    }

    ['click', 'mousemove', 'keydown', 'touchstart'].forEach(event => {
      document.addEventListener(event, resetInactivityTimer);
    });

    resetInactivityTimer();
  </script>

  <!-- Display user in navbar -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const userData = JSON.parse(sessionStorage.getItem("userData") || "{}");
      const displayName = userData.enumerator_code || userData.name || "Pengguna";
      const usernameEl = document.getElementById("username");
      if (usernameEl) {
        usernameEl.innerHTML = `<i class="fas fa-user" style="margin-right:10px;"></i>${displayName}`;
        usernameEl.title = userData.role || "";
      }
    });
  </script>

  <!-- Highlight active sidebar -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const links = document.querySelectorAll('#sidePanel a');
      const currentPath = window.location.pathname;
      let activeLink = null;

      links.forEach(link => {
        const linkPath = new URL(link.href).pathname;
        if (linkPath === currentPath) {
          link.classList.add('active');
          activeLink = link;
        }

        link.addEventListener('mouseenter', () => {
          if (activeLink) activeLink.classList.remove('active');
          link.classList.add('hovered');
        });

        link.addEventListener('mouseleave', () => {
          link.classList.remove('hovered');
          if (activeLink) activeLink.classList.add('active');
        });
      });
    });
  </script>

  <!-- Load respondent data -->
   <script>
    async function loadRespondentData() {
  try {
    const userDataRaw = sessionStorage.getItem("userData");
    if (!userDataRaw) {
      alert("Data pengguna tidak dijumpai. Sila log masuk semula.");
      return;
    }

    const userData = JSON.parse(userDataRaw);
    const enumeratorCode = userData.enumerator_code;
    const role = userData.role || "User";

    let url = "";
    if (role === "Admin") {
      url = "https://atiqahst-github-io.onrender.com/overall-respondents";
    } else {
      if (!enumeratorCode) {
        alert("Kod enumerator tidak ditemui dalam data pengguna.");
        return;
      }
      url = `https://atiqahst-github-io.onrender.com/respondent-history?user=${encodeURIComponent(enumeratorCode)}`;
    }

    const response = await fetch(url);
    if (!response.ok) {
      throw new Error("Rangkaian gagal: " + response.status);
    }

    const data = await response.json();
    const tbody = document.querySelector("#respondent-table tbody");
    tbody.innerHTML = "";

    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 10px;">Tiada data untuk dipaparkan.</td></tr>`;
      return;
    }

    data.forEach(row => {
      const dateObj = new Date(row.date);
      const formattedDate = isNaN(dateObj)
        ? row.date
        : dateObj.toLocaleDateString('ms-MY', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });

      const respondentCount = row.respondent_count || row.total_respondents || 0;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="border: 1px solid #ccc; padding: 10px;">${formattedDate || "—"}</td>
        <td style="border: 1px solid #ccc; padding: 10px;">${row.enumerator_code}</td>
        <td style="border: 1px solid #ccc; padding: 10px;">${respondentCount}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    alert("Gagal memuatkan data.");
    console.error(err);
  }
}

   </script>
  <!-- <script>
    async function loadRespondentData() {
      try {
        const userDataRaw = sessionStorage.getItem("userData");
        if (!userDataRaw) {
          alert("Data pengguna tidak dijumpai. Sila log masuk semula.");
          return;
        }

        const userData = JSON.parse(userDataRaw);
        const enumeratorCode = userData.enumerator_code;
        const role = userData.role || "User";

        let url = "";
        if (role === "Admin") {
          url = "https://atiqahst-github-io.onrender.com/overall-respondents";
        }

        const response = await fetch(url);
        if (!response.ok) {
          throw new Error("Rangkaian gagal: " + response.status);
        }

        const data = await response.json();
        const tbody = document.querySelector("#respondent-table tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 10px;">Tiada data untuk dipaparkan.</td></tr>`;
          return;
        }

        data.forEach(row => {
          const dateObj = new Date(row.date);
          const formattedDate = isNaN(dateObj)
            ? row.date
            : dateObj.toLocaleDateString('ms-MY', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });

          const respondentCount = row.respondent_count || row.total_respondents || 0;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="border: 1px solid #ccc; padding: 10px;">${formattedDate || "—"}</td>
            <td style="border: 1px solid #ccc; padding: 10px;">${row.enumerator_code}</td>
            <td style="border: 1px solid #ccc; padding: 10px;">${respondentCount}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert("Gagal memuatkan data.");
        console.error(err);
      }
    }

    window.addEventListener("load", loadRespondentData);
  </script> -->
</body>
</html>
